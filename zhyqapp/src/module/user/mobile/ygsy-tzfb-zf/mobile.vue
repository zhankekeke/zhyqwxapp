<style scoped>
 .container{
    height:0!important;
}
.lm{
  background:rgba(246,246,246,1);
}
    .wrap {
    min-height:100vh;
    position:relative;
    }
    .fujian {
        overflow:hidden;
        padding: 16px 15px 16px;
        font-size: 14px;
        box-sizing:border-box;
        color: rgb(136, 136, 136);
        background: #fff;
        border-top: 10px solid rgb(243, 243, 243);
    }

   >>> .ordata {
        background:rgba(247,247,247,1);
        font-size: 13px;
       color:rgba(179,179,179,1);
        padding:20px 16px;
        box-sizing:border-box;
        width:95%;
        margin-top:16px;

    }
   >>> .ordata p{
    line-height:30px;

}
     >>> .ivu-input {
        border: none;
        border-radius: 0;
        font-size: 14px;
        background: none;
       margin-top:10px;
        color: #495060;
        text-align:right;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;

    }

>>> .ivu-form-item-error-tip{
    position: absolute;
    /* top: 93%; */
    text-align:right;
    top: 32px;
    right: 24px;
    line-height: 1;
    /* padding-top: 0.16rem; */
    color: #ed3f14;
}
    .ivu-input-wrapper {
        margin-left: 0;
    }

    >>>.ivu-form-item {
        border-bottom: 1px solid #ececec;
        margin-bottom:0;
        height:auto;
        line-height:54px;
        padding-left:16px;
        box-sizing:border-box;
    }

    >>> .ivu-form-item-label {
        font-size: 16px;
        color:#333333;
        font-family:'PingFangSC-Regular';
        line-height:33px;
    }

    >>> .ivu-input-group-append {
        border: none;
        background: none;
    }

    .ql-toolbar.ql-snow {
        display: none;
    }

    >>> .ql-editor {
        line-height: 2;
        padding: 0;
        margin-top:20px;
        margin-bottom:20px;
    }
>>> .ql-editor p{
    color:#333333;
    font-weight:400;
    font-family:'PingFangSC-Regular';
    font-size:14px;
   }
    >>> .ql-container.ql-snow {
        border: none;
        font-size: 14px;
    }
    >>>.ivu-input-group{
        width:auto;
    }
   >>>.ivu-input-group-append img{
       position:absolute;
       top:15px;
       right:-4px;
       width:19px;
       height:19px;
   }
    .modal-btn {
        line-height: 3;
        font-size: 16px;
    }

    >>> .ivu-modal-footer {
        padding: 0;
    }

    >>> .ivu-modal {
        margin: 30px;
    }

    >>> .ivu-input-wrapper {
        width:75%;
    }
    .modal-btn {
        line-height: 3;
        font-size: 16px;
    }

    >>> .ivu-modal-footer {
        padding: 0;
    }

    >>> .ivu-modal {
        margin: 30px;
    }
  >>> .ivu-input:focus{
      box-shadow:none;
  }
  >>> .ivu-input textarea{
      padding-right:0;
  }
    .ivu-btn-primary {
        background-color: rgb(2, 155, 250);
        border-color: rgb(2, 155, 250);
    }
    .demo-upload-list{
        margin-left:45px;
        overflow:scroll;
        max-height:230px;
    }
    >>> .ql-snow .ql-editor img{
        width:30px;
    }
   .wrap .form{
       margin-top:10px;
       background-color:#fff;
   }
   .content{
       margin-top:10px;
       background-color:#fff;
       padding-left:16px;
       padding-top:16px;
       box-sizing:border-box;
   }
   .content p:first-child{
     font-size:16px;
     color:#333333;
      font-family:'PingFangSC-Medium'; 
      font-weight:550;
   }
   .fileList {
        margin-top: 10px;
       padding-bottom:10px;
        height:21px;
    }

    .fileList li {
        line-height: 20px;
        font-size: 14px;
        margin:5px 10px 5px;
    }

    .fileList li img {
       height: 18px;
       width: 18px;
    }

    .fileList li .cancel {
        float: right;
    }
 .fjj2{
     width:14px;
     margin-right:6px;
 }

 >>> .ivu-input-wrapper.ivu-input-type textarea{
     padding-right:0!important;
 }
 >>>.ql-snow .ql-editor pre.ql-syntax{
     background-color:none!important;
 }
 >>> .ql-snow .ql-editor pre {
     background-color: none!important; 
    border-radius: .08rem;
}
 .ivu-upload-drag:hover{
     border:none;
 }
 .footer{
     height:49px;
     line-height:49px;
     background-color:#fff;
     position:absolute;
     bottom:0;
     width:100%;
 }
 .footer span{
     border:none;
     height:49px;
     width:50%;
     float:left;
     border-radius:none;
    font-size:18px;
    border-bottom:none;
    text-align:center;


 }
 .footer span:first-child{
     background-color:#fff;
     color:#333333;
        border-radius:none!important;
    border:1px solid rgba(229,229,229,1);
    border-bottom:none!important;
 }
.footer span:last-child{
       border-radius:none!important;
    background:rgba(0,193,222,1);
    color:#fff;
}
.detail{
    background-color:#fff;
    padding:0 16px;
    box-sizing:border-box;
}
.text .receive{
        margin-top:15px;
    }
    .detail .texts{
        margin-top:15px;
        padding:0 16px;
        box-sizing:border-box;
        padding-bottom:36px;
    }
     .texts ul li{
        width:33.3333%;
        float:left;
        margin-left:10px;
    }
    .texts span{
        font-size:14px;
        font-weight:400;
        font-family:'PingFangSC-Regular';
        color:#333333;
    }
    .texts ul li:first-child{
        margin-left:0;
    }
     >>> .texts p img{
        width:30px;
   }
   .casher{
         float: left;
        margin-right:8px;
        vertical-align:middle;
        margin-top:2px;
        width:24px;
    }
    .detail .item p{
         font-size:16px;
     color:#333333;
      font-family:'PingFangSC-Medium'; 
      font-weight:550;
    }
     .fujian {
        overflow:hidden;
        padding: 25px 15px 0;
        font-size: 14px;
        color: rgb(136, 136, 136);
        background: #fff;
        border-top: 10px solid rgb(243, 243, 243);
    }
     .demo-upload-list{
        margin-left:45px;
        margin-bottom:40px;
    }
    .demo-upload-list .img{
     width: 85px;height: 105px;float:left;position:relative; margin-right:5px;margin-bottom:5px;
    }
  .demo-upload-list .img .imag{
        width:74px;
        height:74px;
    }
    .demo-upload-list .img img:last-child{
        position:absolute;top:0px;right:10px;width:16px;
    }
    .demo-upload-list .add{
       height: 74px; line-height:74px;text-align: center;
    }
    .box{
      position:absolute;
      left:24px;
      top:18px;
    }
    >>> .el-progress-circle{
      width: 25px!important;
      height: 25px!important;
    }
     >>> .el-progress__text{
      top:150%;
      font-size:12px;
    }
    .href{
     height:75px;width:1.9733rem;display:block;line-height:75px;
     text-align:center;
     background:url('/static/yqhd/img.svg') no-repeat center;
     background-size:100% 100%;
     font-size:10px;
     color:#333;
   }
   .popUp >>> .ivu-modal-footer{
   display:none!important;
   }
   .popUp >>> .ivu-modal-header-inner{
       text-align:center;
   }
   .popUp >>> .ivu-modal-close{
       display:none;
   }
    .tit{
        color:#ccc;
        line-height: 25px;

    }
    .url{
        word-wrap:break-word;
        line-height:25px;
        width:100%;
        border:none;
        outline: none;
        background: #fff;
        text-align: left;
    }
</style>
<template>

    <div class="lm" ref="aa">
        <navigator title="转发" @back="$_back_$"/>

        <!--取消发布弹窗-->
        <employeeSelector  :open.sync="isContactOpen" :select.sync="select" @input="onInput"></employeeSelector>
        <!-- 中间部分 -->
        <div class="wrap">

            <Form class="form" ref="formValidate" :model="formValidate" :rules="ruleValidate"
                >
                <FormItem label="接收人:" prop="users">
                    <i-input v-model="formValidate.users" disabled placeholder="请选择">
                        <img  slot="append" @click="$_add_$()" src="/static/tzfb/tzfb_zf_add.svg"/>
                    </i-input>
                </FormItem>
                <FormItem label="标   题:" prop="title">
                    <Input v-model="formValidate.title" placeholder="请输入"></Input>
                </FormItem>
             <FormItem style="margin-left:10px;border-bottom:none;"  label="摘 要:">
                    <Input style="padding-right:0;" v-model="formValidate.description" placeholder="请输入" type="textarea" :rows="3"></Input>
                </FormItem>
            </Form>
          <div class="content">
            <p>正文</p>
             <p class="ordata" v-html="orData.content"  :rows="7"/></p>
            <quill-editor class="edit" placeholder="请输入" ref="editValidate"
                          v-model="formValidate.content"
                          :options="editorOption">
                <div id="toolbar" slot="toolbar"></div>

            </quill-editor>

           </div>
            <!-- <div class="fujian">
           <p style="float: left"> 附件上传:&nbsp;&nbsp;</p>-->
             <div class="fujian">
               <p style="float: left"> 附件:&nbsp;&nbsp;</p>
                <div class="demo-upload-list">
                <div v-for="(item, index) in $_file_$" :key="index" class="images">
                    <div  class="img" >
                        <div class="box" v-if="item && item.percentage">
                            <el-progress v-show="item.percentage != 100" type="circle" :percentage="Math.round(item.percentage.toFixed(0))"></el-progress>
                        </div>
                        <img v-if="formatItem(item)" class="imag" :src=" item.path | imgsrc" alt="" srcset="">
                         <a class="href" v-else @click="pop(item.path)">
                        复制链接</a>
                        <img src="/static/tzfb/cancel.png" alt="" srcset="" @click="remove(index)">
                    </div>
                    <!--<div  v-if="!formatItem(item)"
                    style="width: 105px;height: 105px;float:left;position:relative;background-color:#f6f6f6;
                    text-align:center;">
                        <img style="margin:30px auto 3px;width:30px;" src="/static/tzfb/fjtb.png" alt="" srcset="">
                        <p style="width: 80%;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;
                        margin: 0 auto;">{{item | formatFile}}</p>
                        <img style="position:absolute;top:0px;right:0px;width:16px;"
                            src="/static/tzfb/cancel.png" alt="" srcset="" @click="remove(index)">
                    </div>-->
                </div>
                
              <Upload ref="upload"
                    :show-upload-list="false"
                    :on-success="uploadSuccess"
                    :before-upload="beforeupload"
                    multiple
                    disabled
                    type="drag"
                    :action='uploadServerHost'
                     :on-progress='uploaded'
                    style="display: inline-block;
                     width: 74px;">
                <div class="add">
                    <img style="width: 20px" src="/static/tzfb/tzfb_zf_fj.svg"/>
                </div>
            </Upload>
             </div>
          </div>
           <div class="footer">
             <span @click="$_cancle_$">取消</span>
             <span @click="$_confirm_$">发布 </span>
         </div>
           <Modal class="popUp"
            v-model="popTip"
            title="温馨提示">
             <p class="tit">请复制此链接在浏览器中打开</p>
            <button class="url" v-clipboard:copy="popUrl"
              v-clipboard:success="onCopy"
              v-clipboard:error="onError">
             {{popUrl}}
            </button>
           
        </Modal> 
        </div>
    </div>
</template>

<script>
    import {quillEditor} from 'vue-quill-editor'
    import {Toast} from 'mint-ui';
    import navigator from '../public/navigator';
    import employeeSelector from '../public/employee-selector'
    import {Progress} from 'element-ui';
    export default {
        components: {
            employeeSelector,
            quillEditor,
            navigator,
            [Progress.name]:Progress
        },
        filters:{
            formatFile(val){
                return val.substring(val.lastIndexOf('/')+1,val.length)
            }
        },
        data() {
            const validatetime = (rule, value, callback) => {
                let regEn = /[`~!@#$%^&*_+<>:{}.\/'[\]]/im;
                let regCn = /[#￥ |]/im;
                if (regEn.test(value) || regCn.test(value)) {
                    callback('输入包含非法字符');
                } else {
                    callback();
                }
            };
            const validaReceiver = (rule, value, callback) => {
                if (this.formValidate.users.length == 0) {
                    callback('请选择接收人');
                } else {
                    callback()
                }
            };
            return {
                select: [],
                modalShow: false,
                isContactOpen: false,
                selectedUsers: '',
                 popUrl:'',
                popTip:false,
               editorOption: {
                    placeholder:'请输入...',
                    modules: {toolbar: '#toolbar'}
                    },

                formValidate: {
                    description: '',
                    title: '',
                    content: '',
                    contents:'',
                    type: 0,

                    users: '',
                },
                userInfo: '',
                uploadList: [],
                orData: {},
                ruleValidate: {
                    users: [
                        {required: true, validator: validaReceiver, trigger: 'change'}
                    ],
                    title: [
                        {required: true, message: '请输入通知标题', trigger: 'change'},
                        //长度验证
                        {type: 'string', max: 100, message: '不能超过100字', trigger: 'change'},
                        //特殊字符验证
                        {validator: validatetime, trigger: 'change'}
                    ],
                    description: [
                        //长度验证
                        {type: 'string', max: 500, message: '不能超过500字', trigger: 'change'},

                    ],
                    content: [
                        //长度验证
                        // {required: true, message: '请输入正文内容', trigger: 'change'},
                        //
                        // {type: 'string', max: 500, message: '不能超过500字', trigger: 'change'},
                    ]
                },
                users: [],
                baseUrl: this.$_global_$.ImgServer,
                uploadServerHost: this.$_global_$.uploadServerHost,
                $_file_$:[],
                file:[]
            }
        },
        created() {
            let cookie = this.$_getCookie_$('m-sjwdnnaiowm');
            this.userInfo = JSON.parse(cookie);
            this.$_global_$.ImgServer
            //console.log(this.$root.inparams.data)
            this.orData = this.$root.inparams.datar;
           // console.log(this.orData)
            if(this.orData.files !== ''){
            
            this.$_file_$ = this.orData.files.split(',')
            //console.log(this.$_file_$)
            for(var i=0;i<this.$_file_$.length;i++){
                let ta = this.$_file_$[i]
                this.$set(this.$_file_$,i,{
                    path:this.$_file_$[i]
                })
              }
            }
            //console.log(this.orData)
            this.$_global_$.ImgServer
            this.formValidate.zoneId = this.userInfo.zoneId;
            this.formValidate.enterpriseId = this.userInfo.enterpriseId;

            this.orData.content = ' <span style="width:60px;display:block;">原始文件</span>' +
                '                <p ">收件人：<span>' + this.orData.users + '</span></p>\n' +
                '            <p ">标题：<span>' + this.orData.title + '</span></p>\n' +
                '            <p ">摘要：<span>' + this.orData.description + '</span></p>\n' +
                '            <p ">发送时间：<span>' + this.orData.createDate + '</span>\n' +
                 '            <p ">发送内容：<span>' + this.orData.content + '</span>' +
                '            </p>';

         },
        computed: {
            editor() {
                return this.$refs.editValidate.quill
            }
        },
         //解决软键盘弹起
        mounted(){
           var oHeight = $(document).height();
           window.onresize=function(){

               // console.log(oHeight)
                if($(document).height() < oHeight){
                    $(".footer").css("position","static");
                }else{
                    $(".footer").css("position","absolute"); //adsolute或fixed，看你布局
                }
            }; 
       },
       destroyed() {
           window.onresize = void 0;
       },
        methods: {
            $_back_$() {
                this.$root.$_Route_$('user', 'mobile', 'ygsy-tzfb-fsjl', {})
            },
            $_cancle_$() {
                this.modalShow = true;
                this.$root.$_Route_$('user', 'mobile', 'ygsy-tzfb', {})
            },
            ok() {
                this.$root.$_Route_$('user', 'mobile', 'ygsy-tzfb', {})
            },
            cancel() {
                this.modalShow = false;
            },
             onInput(value) {
               // this.isContactOpen = false;
                this.formValidate.users = '';
                this.users = [];

                for (let i = 0; i < value.length; i++) {
                    this.users.push({uid: value[i].id, read: 0, name: value[i].name});

                    if (!this.formValidate.users) {
                        this.formValidate.users = value[i].name;
                    } else {
                        this.formValidate.users = this.formValidate.users + "、" + value[i].name;
                    }
                }
            },
              pop(item){
              this.popUrl =  this.$_global_$.ImgServer + item
              this.popTip = true
            },
              onCopy () {
                this.$Message.success('复制成功!')
                },
           onError () {
                this.$Message.error('请重新复制')
           },
            $_confirm_$() {
             // console.log(this.users)
             let b={}
             for(var i=0;i<this.$_file_$.length;i++){
                 var temps = ''
                 temps +=this.$_file_$[i].path
                 b=temps
                this.file.push(b)
             }
                this.$refs.formValidate.validate((valid) => {
                    if (valid) {
                       // console.log(valid)
                        this.formValidate.files =  this.file.join(",");
                        this.formValidate.contents = this.orData.content + this.formValidate.content;
                        this.$_sendQuery_$({
                            method: "POST",
                            url: `${this.$_global_$.serverPath}/company/notice`,
                            data:{
                              files:this.formValidate.files,
                              content:this.formValidate.contents,
                              users:JSON.stringify(this.users),
                              title:this.formValidate.title,
                              type:0,
                              description:this.formValidate.description
                            }
                            //data:this.formValidate
                        }).then(res => {
                            //console.log(res)
                            if (res.status === 200) {
                                if (res.data.code === 0) {
                                    Toast('转发成功!');
                                    this.$root.$_Route_$('user', 'mobile', 'ygsy-tzfb-fsjl', {})
                                }
                            }
                        })
                     }else {
                        // Toast('请完成必填项!');
                    }
                
               })

            },
            $_add_$() {
                this.isContactOpen = true;
            },
            beforeupload(file){
               if(file.size > 1024*1024*10){
                    return !! void this.$Message.error('上传图片大小不能超过10MB');
                }
                file.percentage = 0;
                file.path = window.URL.createObjectURL(file)
                this.$_file_$.push(file)

            },
            //进度条
            uploaded( event,file,fileList){
               for(let i =0; i<this.$_file_$.length; i++){
                   // console.log(this.$_file_$)
                    if(this.$_file_$[i].uid === file.uid){
                        let tar = this.$_file_$[i];
                        this.$set(this.$_file_$, i, {
                            uid:tar.uid,
                            name:tar.name,
                            path:tar.path,
                            percentage:file.percentage
                        })
                        break;
                    }
                }

            },
            uploadSuccess(res, file, fileList){
               // this.fileChange(fileList);
                for(let i =0; i<this.$_file_$.length; i++){
                    if(this.$_file_$[i].uid === file.uid){
                        let tar = this.$_file_$[i];
                        this.$set(this.$_file_$, i, {
                            uid:tar.uid,
                            name:tar.name,
                            path:res.data,
                            percentage:file.percentage
                        })
                        break;
                    }
                    //console.log(this.$_file_$)
                }
            },
            remove(index){
                this.$_file_$.splice(index,1)
            },
            // 判断是图片还是附件
            formatItem(item){
                var isImage = item.path.substring(item.path.lastIndexOf(".")+1);
                var imgType = ["jpg","jpeg","png","svg","gif","bmp","webp"]
                if(imgType.indexOf(isImage) > -1){
                    return true
                }else{
                    return false
                }
            },
            handleView(name) {
                this.imgName = name;
                this.visible = file.url
            }
        }
    }
</script>